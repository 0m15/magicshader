{"version":3,"file":"magicshader.js","sources":["../src/index.js"],"sourcesContent":["import { RawShaderMaterial, Color } from 'three';\nimport * as dat from 'dat.gui';\n\nconst magicUniformsToThree = uniforms => {\n  const r = {}\n\n  for (const k in uniforms) {\n    const uniform = uniforms[k];\n    let value = uniforms[k].json.value;\n\n    if (uniform.type === 'bool') {\n      value = !!value;\n    }\n\n    if (typeof value === 'string') {\n      value = new Color(value);\n    }\n\n    r[k] = { value };\n  }\n\n  return r;\n};\n\nconst parseShaders = (vertex, fragment) => {\n  const vertexUniforms = parseGLSL(vertex);\n  const fragmentUniforms = parseGLSL(fragment);\n\n  return {\n    ...vertexUniforms,\n    ...fragmentUniforms,\n  };\n};\n\nconst parseGLSL = source => {\n  const lines = source.match(/uniform (.+?) (.+?);.+\\/\\/.+ms\\((.+?)\\)/gm);\n\n  if (!lines) {\n    return {};\n  }\n\n  const uniforms = {};\n\n  lines.forEach(line => {\n    const [, type, name, jsonString] = line.match(/uniform (.+?) (.+?);.+\\/\\/.+ms\\((.+?)\\)/);\n    let json = {};\n\n    try {\n      eval(`json = ${jsonString}`);\n    } catch (e) {\n      throw new Error(e);\n    }\n\n    if (!json.value) {\n      json.value = 0;\n    }\n\n    uniforms[name] = {\n      name,\n      type,\n      json,\n    };\n  });\n\n  return uniforms;\n};\n\nconst gui = new dat.GUI({\n  name: 'MagicShader',\n});\n\nlet spectorGui;\nlet id = 0;\n\nclass MagicShader extends RawShaderMaterial {\n  constructor(params) {\n    const magicUniforms = parseShaders(params.vertexShader, params.fragmentShader);\n\n    params.uniforms = {\n      ...magicUniformsToThree(magicUniforms),\n      ...params.uniforms,\n    };\n\n    super(params);\n\n    this.params = params;\n    this.magicUniforms = magicUniforms;\n    this.displayName = this.params.name || `Shader n. ${++id}`;\n\n    this.spector();\n    this.bindUI();\n  }\n\n  bindUI() {\n    if (this.gui) {\n      gui.removeFolder(this.gui);\n    }\n\n    this.gui = gui.addFolder(this.displayName);\n\n    Object.keys(this.magicUniforms).forEach(key => {\n      const magicUniform = this.magicUniforms[key];\n      const magicJson = magicUniform.json;\n      const uniform = this.uniforms[key];\n      const folder = this.gui.addFolder(magicJson.name || `ðŸ”® ${magicUniform.type} - ${key}`);\n\n      if (uniform.value instanceof Color) {\n        const add = folder.addColor(magicJson, 'value').onChange(res => {\n          uniform.value.set(res);\n        });\n\n        add.listen();\n      } else if (Array.isArray(magicJson.value)) {\n        Object.keys(uniform.value).forEach(index => {\n          const add = folder.add(uniform.value, index);\n\n          magicJson.step && add.step(magicJson.step);\n\n          if (magicJson.range && magicJson.range[index] && magicJson.range[index].length === 2) {\n            add.min(magicJson.range[index][0]);\n            add.max(magicJson.range[index][1]);\n          }\n\n          add.listen();\n        });\n      } else {\n        const add = folder.add(uniform, 'value');\n\n        magicJson.step && add.step(magicJson.step);\n        magicJson.options && add.options(magicJson.options);\n\n        if (magicJson.range && magicJson.range.length === 2) {\n          add.min(magicJson.range[0]);\n          add.max(magicJson.range[1]);\n        }\n\n        add.listen();\n      }\n    });\n  }\n  \n  // Spector.js stuff\n  spector() {\n    if (!window.spector) {\n      return;\n    }\n\n    if (!spectorGui) {\n      // Just once, for the whole context.\n      spectorGui = gui.addFolder('ðŸ“ˆ Spector');\n\n      this.spectorFPS = 0;\n      setInterval(() => {\n        this.spectorFPS = spector.getFps();\n      }, 200);\n\n      spectorGui.add(this, 'spectorFPS').name('FPS').listen();\n      spectorGui.add(this, 'capture');\n    }\n    \n    this.checkProgram = this.checkProgram.bind(this);\n    this.checkProgramInterval = setInterval(this.checkProgram, 200);\n  }\n\n  capture() {\n    const instance = document.querySelector('canvas');\n    spector.captureNextFrame(instance);\n  }\n\n  checkProgram() {\n    if (this.program && this.program.program) {\n      this.program.program.__SPECTOR_Object_TAG.displayText = this.displayName;\n      this.program.vertexShader.__SPECTOR_Object_TAG.displayText = `Vertex - ${this.displayName}`;\n      this.program.fragmentShader.__SPECTOR_Object_TAG.displayText = `Fragment - ${this.displayName}`;\n\n      this.program.program.__SPECTOR_rebuildProgram = this.rebuildShader.bind(this);\n      clearInterval(this.checkProgramInterval);\n    }\n  }\n\n  rebuildShader(vertex, fragment, onCompile, onError) {\n    this.vertexShader = vertex;\n    this.fragmentShader = fragment;\n    \n    this.magicUniforms = parseShaders(vertex, fragment);\n    this.uniforms = {\n      ...this.uniforms,\n      ...magicUniformsToThree(this.magicUniforms),\n    };\n    \n    this.needsUpdate = true;\n    this.bindUI();\n\n    onCompile(this.program.program);\n    this.checkProgramInterval = setInterval(this.checkProgram, 200);\n  }\n}\n\nexport { gui };\nexport default MagicShader;\n"],"names":["magicUniformsToThree","uniforms","r","const","k","value","json","type","Color","parseShaders","vertex","fragment","vertexUniforms","parseGLSL","fragmentUniforms","Object","source","lines","match","forEach","line","eval","jsonString","e","Error","name","gui","dat","spectorGui","id","MagicShader","constructor","params","magicUniforms","vertexShader","fragmentShader","displayName","this","spector","bindUI","removeFolder","addFolder","keys","key","magicUniform","magicJson","uniform","folder","addColor","onChange","res","set","listen","Array","isArray","index","add","step","range","length","min","max","options","window","spectorFPS","setInterval","getFps","checkProgram","bind","checkProgramInterval","capture","instance","document","querySelector","captureNextFrame","program","__SPECTOR_Object_TAG","displayText","__SPECTOR_rebuildProgram","rebuildShader","clearInterval","onCompile","onError","needsUpdate","RawShaderMaterial"],"mappings":"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"}